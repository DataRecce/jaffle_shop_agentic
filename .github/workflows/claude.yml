name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # For PR events, checkout PR head; for issue_comment, will be updated in Get PR information step
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Checkout Recce Repository
        uses: actions/checkout@v4
        with:
          repository: 'DataRecce/recce'
          path: 'recce-repo'
          # TODO: Update to stable release tag once available (e.g., v1.0.0)
          # Currently using feature branch for MCP implementation
          ref: 'feature/drc-1893-implement-the-mcp-server-in-recce'
          # Shallow clone to minimize download time and storage
          fetch-depth: 1
          # Disable sparse-checkout for now to ensure all necessary files for pip install are available
          # sparse-checkout and sparse-checkout-cone-mode can be enabled if we identify specific paths needed

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          # Python 3.10 is used for compatibility with Recce and dbt-core
          # Recce requires Python 3.9+ per its setup.py
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python3.10/site-packages
          key: pip-recce-${{ runner.os }}-py3.10-${{ hashFiles('requirements.txt', 'recce-repo/setup.py', 'recce-repo/recce/VERSION') }}
          restore-keys: |
            pip-recce-${{ runner.os }}-py3.10-${{ hashFiles('requirements.txt') }}-
            pip-recce-${{ runner.os }}-py3.10-
            pip-recce-

      - name: Cache dbt packages
        uses: actions/cache@v4
        with:
          path: |
            dbt_packages/
            ~/.dbt/
          key: dbt-packages-${{ hashFiles('packages.yml') }}
          restore-keys: |
            dbt-packages-

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Install dbt packages
        run: |
          dbt deps

      - name: Install Recce from source
        run: |
          # Verify checkout directory exists and contains setup.py
          if [ ! -d "./recce-repo" ]; then
            echo "::error::Recce repository not found at ./recce-repo"
            exit 1
          fi
          
          if [ ! -f "./recce-repo/setup.py" ]; then
            echo "::error::setup.py not found in recce-repo. Checkout may be incomplete."
            exit 1
          fi
          
          # Verify VERSION file exists (required by setup.py)
          if [ ! -f "./recce-repo/recce/VERSION" ]; then
            echo "::error::VERSION file not found. Package data may be incomplete."
            exit 1
          fi
          
          # Upgrade pip, setuptools, and wheel to ensure proper dependency resolution
          echo "Upgrading pip, setuptools, and wheel..."
          pip install --upgrade pip setuptools wheel
          
          # Install packaging first (required by some dependencies)
          echo "Installing base dependencies..."
          pip install packaging
          
          # Install Recce with all dependencies
          # Using -e for editable mode, with explicit dependency installation
          echo "Installing Recce from source with all dependencies..."
          pip install -e "./recce-repo[dev]"
          
          # Install any missing common dependencies that might not be in setup.py
          echo "Installing additional common dependencies..."
          pip install pytz tzdata
          
          # Verify installation
          if command -v recce >/dev/null 2>&1; then
            echo "✓ Recce installed successfully: $(which recce)"
            echo "✓ Recce version: $(recce version)"
          else
            echo "::error::Recce installation failed - command not found"
            exit 1
          fi
          
          # Verify critical dependencies are installed
          echo "Verifying critical dependencies..."
          python -c "import pytz; import mcp; import fastapi; import click; print('✓ All critical dependencies verified')" || {
            echo "::error::Some critical dependencies are missing"
            echo "Installed packages:"
            pip list
            exit 1
          }

      - name: Get PR information
        if: github.event.pull_request != null || github.event.issue.pull_request != null
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            # For issue comments on PRs, fetch PR details
            PR_NUMBER=${{ github.event.issue.number }}
            PR_DATA=$(gh pr view $PR_NUMBER --json baseRefName,headRefName,headRefOid --repo ${{ github.repository }})
            BASE_REF=$(echo $PR_DATA | jq -r '.baseRefName')
            HEAD_SHA=$(echo $PR_DATA | jq -r '.headRefOid')
            BASE_SHA=$(gh api repos/${{ github.repository }}/git/ref/heads/$BASE_REF --jq '.object.sha')

            echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
            echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
            echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

            # Debug output
            echo "::notice::PR Base Branch: $BASE_REF (SHA: $BASE_SHA)"
            echo "::notice::PR Head SHA: $HEAD_SHA"

            # Clean working directory before checkout to avoid conflicts
            echo "Cleaning working directory before checkout..."
            git add -A
            git stash push -m "Temporary stash before PR head checkout" || echo "Nothing to stash"

            # Checkout PR head commit for issue comments
            echo "Checking out PR head commit..."
            git fetch origin $HEAD_SHA
            git checkout $HEAD_SHA

            # Restore stashed changes if any
            if git stash list | grep -q "Temporary stash before PR head checkout"; then
              git stash pop || echo "::warning::Could not restore stashed changes"
            fi
          else
            # For PR events, use event data directly
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"

            echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
            echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
            echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

            # Debug output
            echo "::notice::PR Base Branch: $BASE_REF (SHA: $BASE_SHA)"
            echo "::notice::PR Head SHA: $HEAD_SHA"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Prepare dbt Current environment
        if: github.event.pull_request != null || github.event.issue.pull_request != null
        id: prepare-current
        continue-on-error: true
        run: |
          echo "::group::Generating current environment artifacts"
          echo "Current branch/commit: ${{ steps.pr-info.outputs.head_sha }}"

          # Generate current artifacts with error handling (already on PR head)
          EXIT_CODE=0
          dbt seed || { echo "::warning::dbt seed failed for current environment"; EXIT_CODE=1; }
          dbt run || { echo "::warning::dbt run failed for current environment"; EXIT_CODE=1; }
          dbt docs generate || { echo "::warning::dbt docs generate failed for current environment"; EXIT_CODE=1; }

          # Set output to indicate success
          echo "success=$([[ $EXIT_CODE -eq 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Cache base target artifacts
        if: github.event.pull_request != null || github.event.issue.pull_request != null
        id: cache-base-target
        uses: actions/cache@v4
        with:
          path: target-base/
          key: dbt-base-${{ steps.pr-info.outputs.base_ref }}-${{ steps.pr-info.outputs.base_sha }}-${{ hashFiles('models/**/*.sql', 'seeds/**/*.csv', 'dbt_project.yml') }}
          restore-keys: |
            dbt-base-${{ steps.pr-info.outputs.base_ref }}-${{ steps.pr-info.outputs.base_sha }}-
            dbt-base-${{ steps.pr-info.outputs.base_ref }}-

      - name: Prepare dbt Base environment
        if: (github.event.pull_request != null || github.event.issue.pull_request != null) && steps.cache-base-target.outputs.cache-hit != 'true'
        id: prepare-base
        continue-on-error: true
        run: |
          echo "::group::Generating base environment artifacts"
          echo "Base branch: ${{ steps.pr-info.outputs.base_ref }}"
          echo "Base SHA: ${{ steps.pr-info.outputs.base_sha }}"

          # Save PR-specific files that might not exist in base branch
          mkdir -p /tmp/pr-files
          if [ -f ".github/mcp_config.json" ]; then
            cp .github/mcp_config.json /tmp/pr-files/
          fi

          # Clean working directory before checkout to avoid conflicts with new files
          # This prevents "untracked working tree files would be overwritten" errors
          echo "Cleaning working directory..."
          git add -A
          git stash push -m "Temporary stash before base checkout" || echo "Nothing to stash"

          # Checkout base branch to a detached HEAD
          echo "Checking out base branch..."
          git fetch origin ${{ steps.pr-info.outputs.base_ref }}
          git checkout -q origin/${{ steps.pr-info.outputs.base_ref }}

          # Generate base artifacts with error handling and capture exit codes
          echo "Generating base artifacts..."
          EXIT_CODE=0
          dbt seed --target-path target-base || { echo "::warning::dbt seed failed for base environment"; EXIT_CODE=1; }
          dbt run --target-path target-base || { echo "::warning::dbt run failed for base environment"; EXIT_CODE=1; }
          dbt docs generate --target-path target-base || { echo "::warning::dbt docs generate failed for base environment"; EXIT_CODE=1; }

          # Return to original branch/commit
          echo "Returning to PR head..."
          git checkout -q ${{ steps.pr-info.outputs.head_sha }}

          # Restore stashed changes if any
          if git stash list | grep -q "Temporary stash before base checkout"; then
            git stash pop || echo "::warning::Could not restore stashed changes"
          fi

          # Restore PR-specific files
          if [ -f "/tmp/pr-files/mcp_config.json" ]; then
            mkdir -p .github
            cp /tmp/pr-files/mcp_config.json .github/
          fi

          # Set output to indicate if base artifacts were successfully generated
          echo "success=$([[ $EXIT_CODE -eq 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Validate Base Artifacts
        if: github.event.pull_request != null || github.event.issue.pull_request != null
        id: validate-base
        run: |
          # Check if base artifacts exist (either from cache or just generated)
          if [ -f "target-base/manifest.json" ] && [ -f "target-base/catalog.json" ]; then
            echo "✓ Base artifacts found"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Base artifacts not found. Recce comparison features may be limited."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare System Prompt
        if: github.event.pull_request != null || github.event.issue.pull_request != null
        id: system-prompt
        run: |
          # Load response format template
          if [ ! -f ".github/prompts/recce-analysis-format.md" ]; then
            echo "::error::Response format guide not found at .github/prompts/recce-analysis-format.md"
            exit 1
          fi
          
          FORMAT_GUIDE=$(cat .github/prompts/recce-analysis-format.md)
          
          # Compose complete system prompt with mandatory format enforcement
          cat > /tmp/system_prompt.txt <<'EOF'
          You are analyzing a dbt project Pull Request with Recce MCP tools available.
          
          ## 🎯 Primary Objective: Execute Recce Preset Checks
          
          **CRITICAL EXECUTION FLOW (MANDATORY ORDER):**
          
          ### Phase 1: Read Project Configuration (REQUIRED)
          1. **FIRST ACTION**: Read the project's `recce.yml` file from the workspace root
          2. Parse the `checks` section to identify all preset validation checks
          3. Note each check's name, type, description, and params
          
          ### Phase 2: Execute ALL Preset Checks (MANDATORY)
          Execute EVERY check defined in `recce.yml` sequentially using the appropriate Recce MCP tools:
          
          **Check Type Mapping:**
          - `schema_diff` → Use `mcp__recce__get_lineage_diff` and analyze schema changes
          - `row_count_diff` → Use `mcp__recce__row_count_diff` with the `select` parameter
          - `value_diff` → Use `mcp__recce__query_diff` or `mcp__recce__profile_diff` for specific columns
          - `query_diff` → Use `mcp__recce__query_diff` with the provided `sql_template`
          - `profile_diff` → Use `mcp__recce__profile_diff` for statistical analysis
          
          **Execution Requirements:**
          - Execute checks in the order they appear in `recce.yml`
          - Use the exact parameters specified in each check's `params` section
          - Collect all results before proceeding to Phase 3
          - If a check fails to execute, document the error and continue with remaining checks
          
          ### Phase 3: Analyze Results and Determine Output Format
          
          **Decision Logic:**
          - **IF any check result shows anomalies** (threshold exceeded, unexpected changes, data quality issues):
            → Output FULL PR Validation Summary using the format template below
          - **IF all checks pass without anomalies**:
            → Output brief success message: "✅ All Recce preset checks passed. No anomalies detected."
          
          **Anomaly Detection Criteria:**
          - Row count changes > 5% (or custom threshold in check definition)
          - Schema changes (added/removed/modified columns)
          - Profile metrics exceed specified thresholds
          - Unexpected NULL values or data quality issues
          - Query diff results show significant variance
          
          ### Phase 4: Handle User's Additional Request (OPTIONAL)
          
          **CRITICAL CONTEXT HANDLING RULES:**
          1. **IGNORE all historical PR comments** - only process the LATEST comment that mentions @claude
          2. **COMPLETE Phases 1-3 FIRST** before addressing any user-specific requests
          3. If the user's comment contains additional instructions:
             - Add a new section at the end: "## 📎 Additional Analysis (Per User Request)"
             - Address the specific request AFTER completing preset checks
          4. If the user's request conflicts with preset checks or format requirements:
             - Prioritize preset checks and format rules
             - Explain the constraint politely in the response
          
          **Context Isolation Strategy:**
          - The GitHub Action triggers on issue_comment events, which includes ALL historical comments
          - You MUST identify and extract ONLY the triggering @claude mention from the latest comment
          - Treat all previous comments as noise and NEVER reference or respond to them
          - Focus exclusively on: preset checks first, then latest @claude request if applicable
          
          ---
          
          ## Response Format Requirements
          
          **ONLY use this detailed format when anomalies are detected in Phase 3.**
          
          CRITICAL RULES (NON-NEGOTIABLE):
          1. Use "# PR Validation Summary" as the main title (H1 heading)
          2. Follow the section order EXACTLY as specified
          3. Use the EXACT section titles with emoji indicators
          4. Separate major sections with "---" horizontal rules
          5. Include ALL [REQUIRED] sections even if content is brief
          6. You may omit [OPTIONAL] sections if not applicable, but maintain section order
          7. For Profile Diff and Row Count data, PREFER markdown tables; use lists ONLY if table data is incomplete
          8. Use concrete values from Recce tool results, NEVER use placeholders like "X" or "value"
          
          EOF
          
          # Append the complete format template
          echo "" >> /tmp/system_prompt.txt
          echo "$FORMAT_GUIDE" >> /tmp/system_prompt.txt
          
          # Add execution notes
          cat >> /tmp/system_prompt.txt <<'EOF'
          
          ---
          
          ## ⚙️ Execution Checklist
          
          Before responding, verify you have:
          
          - [ ] ✅ Phase 1: Read and parsed `recce.yml` from workspace root
          - [ ] ✅ Phase 2: Executed ALL preset checks defined in `recce.yml` using appropriate MCP tools
          - [ ] ✅ Phase 3: Analyzed results and determined if anomalies exist
          - [ ] ✅ Phase 3: Chose correct output format (brief success OR full validation summary)
          - [ ] ✅ Phase 4: Identified ONLY the latest @claude comment (ignored all historical comments)
          - [ ] ✅ Phase 4: Addressed user's additional request (if any) AFTER preset checks
          - [ ] ✅ Validation: All concrete values from actual Recce MCP results (no placeholders)
          - [ ] ✅ Validation: If using full format, verified against Output Validation Checklist
          
          ## 🚫 Common Mistakes to Avoid
          
          1. **DO NOT skip reading `recce.yml`** - this is the first mandatory step
          2. **DO NOT execute generic checks** - only execute checks defined in `recce.yml`
          3. **DO NOT respond to historical comments** - only the latest @claude mention matters
          4. **DO NOT output full report if all checks pass** - use brief success message instead
          5. **DO NOT let user requests override preset checks** - always complete preset checks first
          6. **DO NOT use placeholder values** - all data must come from actual MCP tool results
          
          ## Example Execution Flow
          
          **Scenario A: All Checks Pass**
          ```
          1. Read recce.yml → Found 4 preset checks
          2. Execute schema_diff for customers, orders, modified nodes → No schema changes
          3. Execute row_count_diff for customers, orders → Counts stable
          4. Execute value_diff for customers.customer_lifetime_value → 100% match
          5. Execute query_diff for avg lifetime value → No variance
          6. Result: All checks passed
          7. Output: "✅ All Recce preset checks passed. No anomalies detected."
          8. Check latest comment for additional requests → None
          9. Done
          ```
          
          **Scenario B: Anomaly Detected**
          ```
          1. Read recce.yml → Found 4 preset checks
          2. Execute schema_diff → No changes
          3. Execute row_count_diff → customers: -15% (ANOMALY)
          4. Execute value_diff → 95% match (ANOMALY: 5% mismatch)
          5. Execute query_diff → avg variance -32.1% (ANOMALY)
          6. Result: Multiple anomalies detected
          7. Output: Full PR Validation Summary with detailed findings
          8. Check latest comment for additional requests → User asks "check SQL performance"
          9. Add "## 📎 Additional Analysis" section with SQL performance check
          10. Done
          ```
          
          REMEMBER: 
          - recce.yml defines the checks → Execute them ALL → Analyze results → Choose output format → Handle user request
          - Latest @claude comment ONLY, ignore all history
          - Preset checks are mandatory, user requests are additive
          EOF
          
          # Store prompt file path for next step
          echo "prompt_file=/tmp/system_prompt.txt" >> $GITHUB_OUTPUT
          
          # Display prompt for debugging (first 50 lines)
          echo "::group::System Prompt Preview"
          head -50 /tmp/system_prompt.txt
          echo "::endgroup::"

      - name: Validate MCP Configuration
        if: github.event.pull_request != null || github.event.issue.pull_request != null
        run: |
          # Show current working directory and files for debugging
          echo "Current directory: $(pwd)"
          echo "MCP config path: $(pwd)/.github/mcp_config.json"
          ls -la .github/ || echo "No .github directory"
          
          # Validate MCP config file exists and is valid JSON
          if [ -f ".github/mcp_config.json" ]; then
            echo "✓ MCP configuration file found"
            if jq empty .github/mcp_config.json 2>/dev/null; then
              echo "✓ MCP configuration is valid JSON"
              cat .github/mcp_config.json
            else
              echo "::error::MCP configuration is invalid JSON"
              exit 1
            fi
          else
            echo "::error::MCP configuration file not found at .github/mcp_config.json"
            exit 1
          fi
          
          # Check if Recce CLI is installed and has mcp-server command
          if command -v recce >/dev/null 2>&1; then
            echo "✓ Recce CLI is installed: $(which recce)"
            # Test if mcp-server command is available
            if recce mcp-server --help >/dev/null 2>&1; then
              echo "✓ Recce MCP server command is available"
            else
              echo "::error::Recce CLI found but mcp-server command not available"
              echo "This may indicate the feature branch is not installed correctly"
              exit 1
            fi
          else
            echo "::error::Recce CLI not found in PATH"
            exit 1
          fi

      - name: Test Recce MCP Server
        if: github.event.pull_request != null || github.event.issue.pull_request != null
        run: |
          echo "Testing Recce MCP server startup..."

          echo "Testing Recce MCP server with full parameters..."
          CMD="recce mcp-server --project-dir . --profiles-dir . --config recce.yml --target-path target --target-base-path target-base"
          echo "Command: $CMD"

          # 啟動並收集輸出
          LOG_FILE="recce_mcp_startup.log"
          timeout 5s bash -c "$CMD" >"$LOG_FILE" 2>&1 & 
          MCP_PID=$!

          sleep 1

          if ! kill -0 "$MCP_PID" 2>/dev/null; then
            echo "::error::Recce MCP server failed to start"
            cat "$LOG_FILE" || true
            exit 1
          fi

          # 檢查是否有「Too few parameters」錯誤
          if grep -q "Too few parameters" "$LOG_FILE"; then
            echo "::error::Recce MCP server start error detected: Too few parameters"
            cat "$LOG_FILE"
            kill "$MCP_PID" || true
            exit 1
          fi

          echo "✓ Recce MCP server started without parameter errors (PID: $MCP_PID)"
          kill "$MCP_PID"

      - name: Run Claude Code with Recce MCP
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Configure Recce MCP tools via claude_args
          # Available tools: get_lineage_diff, row_count_diff, query, query_diff, profile_diff
          # Note: Recce tools are only available when running in PR context with artifacts
          claude_args: |
            --mcp-config .github/mcp_config.json
            --max-turns 50
            --system-prompt-file ${{ steps.system-prompt.outputs.prompt_file }}
            --allowedTools "Bash(recce),Bash(recce mcp-server),Bash(ls target/manifest.json),Bash(ls target-base/manifest.json),Bash(gh pr view:*),Bash(jq -r *),mcp__recce__get_lineage_diff,mcp__recce__row_count_diff,mcp__recce__query,mcp__recce__query_diff,mcp__recce__profile_diff"
