name: dbt Base Environment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      DBT_BASE_TARGET: "prod"
      # Snowflake credentials
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE || 'RECCE' }}
      SNOWFLAKE_SCHEMA: "PUBLIC"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/lib/python3.13/site-packages
          key: pip-dbt-base-${{ runner.os }}-py3.13-snowflake-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-dbt-base-${{ runner.os }}-py3.13-snowflake-
            pip-dbt-base-${{ runner.os }}-py3.13-

      - name: Cache dbt packages
        uses: actions/cache@v4
        with:
          path: |
            dbt_packages/
            ~/.dbt/
          key: dbt-packages-${{ hashFiles('packages.yml') }}
          restore-keys: |
            dbt-packages-

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Install dbt packages
        run: |
          dbt deps

      - name: Display database configuration
        run: |
          echo "::notice::Database Type: Snowflake"
          echo "::notice::Target: ${{ env.DBT_BASE_TARGET }}"
          echo "::notice::Schema: ${{ env.SNOWFLAKE_SCHEMA }}"

      - name: Build dbt Base environment
        id: build-base
        run: |
          echo "::group::Generating base environment artifacts"
          echo "Branch: main"
          echo "Target: ${{ env.DBT_BASE_TARGET }}"

          # Generate base artifacts
          dbt seed --target ${{ env.DBT_BASE_TARGET }}
          dbt run --target ${{ env.DBT_BASE_TARGET }}
          dbt docs generate --target ${{ env.DBT_BASE_TARGET }}

          echo "::endgroup::"

      - name: Validate artifacts
        id: validate
        run: |
          if [ -f "target/manifest.json" ] && [ -f "target/catalog.json" ]; then
            echo "✓ Base artifacts generated successfully"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Base artifacts not found"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload base artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dbt-artifacts-base-main
          path: target/
          retention-days: 30
          if-no-files-found: error

      - name: Summary
        if: always()
        run: |
          echo "## dbt Base Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Database Type:** Snowflake" >> $GITHUB_STEP_SUMMARY
          echo "**Schema:** ${{ env.SNOWFLAKE_SCHEMA }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ env.DBT_BASE_TARGET }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate.outputs.exists }}" == "true" ]; then
            echo "✅ **Base artifacts:** Generated and uploaded as \`dbt-artifacts-base-main\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Retention:** 30 days" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Base artifacts:** Failed to generate" >> $GITHUB_STEP_SUMMARY
          fi
